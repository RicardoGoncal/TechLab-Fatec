name: Debug Runner

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: [self-hosted, linux, X64]

    steps:
      - name: Exibir informações do sistema
        run: |
          echo "📌 Hostname: $(hostname)"
          echo "📌 IP do Servidor: $(hostname -I)"
          echo "📌 Usuário atual: $(whoami)"
          echo "📌 Diretório atual: $(pwd)"
          echo "📌 Checando processos ativos do runner:"
          ps aux | grep actions-runner


      - name: Instalar/Reinstalar Docker
        run: |
          echo "📌 Instalando o Docker novamente..."
          sudo apt-get update
          sudo apt-get remove -y docker docker-engine docker.io containerd runc
          sudo apt-get install -y docker.io
          
          echo "📌 Iniciando o Docker após a instalação..."
          sudo systemctl start docker
          
          echo "📌 Verificando se o Docker está rodando..."
          docker ps || echo "⚠️ Ainda não foi possível conectar ao Docker!"


      - name: Verificar Docker
        run: |
          echo "📌 Verificando se o Docker está instalado..."
          if command -v docker &> /dev/null; then
            echo "✅ Docker está instalado!"
            echo "📌 Versão do Docker:"
            docker --version
          else
            echo "❌ Docker não encontrado!"
            exit 1
          fi

      - name: Verificar status do Docker Daemon
        run: |
          echo "📌 Status do serviço Docker:"
          sudo systemctl status docker || echo "⚠️ Falha ao verificar o status"

      - name: Verificar permissões do Docker
        run: |
          echo "📌 Checando permissões do Docker para o usuário atual..."
          if groups | grep -q '\bdocker\b'; then
            echo "✅ Usuário faz parte do grupo docker"
          else
            echo "❌ Usuário NÃO está no grupo docker"
            echo "📌 Adicionando usuário ao grupo docker..."
            sudo usermod -aG docker $(whoami) || echo "⚠️ Falha ao adicionar usuário ao grupo"
            echo "📌 Para aplicar as mudanças, reinicie o runner manualmente!"
          fi

      - name: Testar acesso ao Docker
        run: |
          echo "📌 Tentando rodar docker ps..."
          docker ps || echo "⚠️ Falha ao acessar o Docker (talvez o daemon não esteja rodando?)"

      
      - name: Diagnóstico do Docker
        run: |
          echo "📌 Verificando processos do Docker..."
          ps aux | grep dockerd || echo "⚠️ dockerd não está rodando como processo!"
          
          echo "📌 Verificando se o socket do Docker existe..."
          ls -lah /var/run/docker.sock || echo "⚠️ Socket do Docker não encontrado!"

          echo "📌 Verificando como o Docker está rodando..."
          if [ -S /var/run/docker.sock ]; then
            echo "✅ O socket do Docker está presente!"
          else
            echo "❌ O Docker não parece estar rodando corretamente!"
          fi


      - name: Iniciar Docker Manualmente
        run: |
          echo "📌 Tentando iniciar o Docker..."
          sudo dockerd > /dev/null 2>&1 &

          echo "📌 Aguardando 5 segundos para o Docker iniciar..."
          sleep 5
          
          echo "📌 Testando conexão com Docker..."
          docker ps || echo "⚠️ Ainda não foi possível conectar ao Docker!"


      - name: Ajustar Permissões do Docker
        run: |
          echo "📌 Garantindo que o usuário tem acesso ao Docker..."
          sudo chmod 666 /var/run/docker.sock
