name: Debug Runner

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: [self-hosted, linux, X64]

    steps:
      - name: Exibir informaÃ§Ãµes do sistema
        run: |
          echo "ğŸ“Œ Hostname: $(hostname)"
          echo "ğŸ“Œ IP do Servidor: $(hostname -I)"
          echo "ğŸ“Œ UsuÃ¡rio atual: $(whoami)"
          echo "ğŸ“Œ DiretÃ³rio atual: $(pwd)"
          echo "ğŸ“Œ Checando processos ativos do runner:"
          ps aux | grep actions-runner


      - name: Instalar/Reinstalar Docker
        run: |
          echo "ğŸ“Œ Instalando o Docker novamente..."
          sudo apt-get update
          sudo apt-get remove -y docker docker-engine docker.io containerd runc
          sudo apt-get install -y docker.io
          
          echo "ğŸ“Œ Iniciando o Docker apÃ³s a instalaÃ§Ã£o..."
          sudo systemctl start docker
          
          echo "ğŸ“Œ Verificando se o Docker estÃ¡ rodando..."
          docker ps || echo "âš ï¸ Ainda nÃ£o foi possÃ­vel conectar ao Docker!"


      - name: Verificar Docker
        run: |
          echo "ğŸ“Œ Verificando se o Docker estÃ¡ instalado..."
          if command -v docker &> /dev/null; then
            echo "âœ… Docker estÃ¡ instalado!"
            echo "ğŸ“Œ VersÃ£o do Docker:"
            docker --version
          else
            echo "âŒ Docker nÃ£o encontrado!"
            exit 1
          fi

      - name: Verificar status do Docker Daemon
        run: |
          echo "ğŸ“Œ Status do serviÃ§o Docker:"
          sudo systemctl status docker || echo "âš ï¸ Falha ao verificar o status"

      - name: Verificar permissÃµes do Docker
        run: |
          echo "ğŸ“Œ Checando permissÃµes do Docker para o usuÃ¡rio atual..."
          if groups | grep -q '\bdocker\b'; then
            echo "âœ… UsuÃ¡rio faz parte do grupo docker"
          else
            echo "âŒ UsuÃ¡rio NÃƒO estÃ¡ no grupo docker"
            echo "ğŸ“Œ Adicionando usuÃ¡rio ao grupo docker..."
            sudo usermod -aG docker $(whoami) || echo "âš ï¸ Falha ao adicionar usuÃ¡rio ao grupo"
            echo "ğŸ“Œ Para aplicar as mudanÃ§as, reinicie o runner manualmente!"
          fi

      - name: Testar acesso ao Docker
        run: |
          echo "ğŸ“Œ Tentando rodar docker ps..."
          docker ps || echo "âš ï¸ Falha ao acessar o Docker (talvez o daemon nÃ£o esteja rodando?)"

      
      - name: DiagnÃ³stico do Docker
        run: |
          echo "ğŸ“Œ Verificando processos do Docker..."
          ps aux | grep dockerd || echo "âš ï¸ dockerd nÃ£o estÃ¡ rodando como processo!"
          
          echo "ğŸ“Œ Verificando se o socket do Docker existe..."
          ls -lah /var/run/docker.sock || echo "âš ï¸ Socket do Docker nÃ£o encontrado!"

          echo "ğŸ“Œ Verificando como o Docker estÃ¡ rodando..."
          if [ -S /var/run/docker.sock ]; then
            echo "âœ… O socket do Docker estÃ¡ presente!"
          else
            echo "âŒ O Docker nÃ£o parece estar rodando corretamente!"
          fi


      - name: Iniciar Docker Manualmente
        run: |
          echo "ğŸ“Œ Tentando iniciar o Docker..."
          sudo dockerd > /dev/null 2>&1 &

          echo "ğŸ“Œ Aguardando 5 segundos para o Docker iniciar..."
          sleep 5
          
          echo "ğŸ“Œ Testando conexÃ£o com Docker..."
          docker ps || echo "âš ï¸ Ainda nÃ£o foi possÃ­vel conectar ao Docker!"


      - name: Ajustar PermissÃµes do Docker
        run: |
          echo "ğŸ“Œ Garantindo que o usuÃ¡rio tem acesso ao Docker..."
          sudo chmod 666 /var/run/docker.sock
